# Secure nginx configuration for streaming server
# Add this to your nginx.conf or site configuration

server {
    listen 443 ssl http2;
    server_name stream.drishtinstitute.com;
    
    ssl_certificate /path/to/ssl/certificate.crt;
    ssl_certificate_key /path/to/ssl/private.key;
    
    # Security headers
    add_header X-Frame-Options DENY;
    add_header X-Content-Type-Options nosniff;
    add_header X-XSS-Protection "1; mode=block";
    add_header Referrer-Policy "strict-origin-when-cross-origin";
    
    # Restrict CORS to only your domain
    location ~* \.(m3u8|ts)$ {
        # Check referer header
        if ($http_referer !~ "^https://drishtinstitute\.com") {
            return 403;
        }
        
        # Restrict CORS to your domain only
        add_header Access-Control-Allow-Origin "https://drishtinstitute.com";
        add_header Access-Control-Allow-Methods "GET, OPTIONS";
        add_header Access-Control-Allow-Headers "DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization";
        add_header Access-Control-Allow-Credentials true;
        
        # Prevent caching of live streams
        add_header Cache-Control "no-cache, no-store, must-revalidate";
        add_header Pragma "no-cache";
        add_header Expires "0";
        
        # Serve HLS files
        root /var/www/hls;
        try_files $uri =404;
        
        # Optional: Add authentication check
        # auth_request /auth;
    }
    
    # Optional: Authentication endpoint
    location = /auth {
        internal;
        proxy_pass http://localhost:3001/verify-stream-token;
        proxy_pass_request_body off;
        proxy_set_header Content-Length "";
        proxy_set_header X-Original-URI $request_uri;
        proxy_set_header X-Original-Method $request_method;
        proxy_set_header X-Real-IP $remote_addr;
    }
    
    # Block direct access to stream keys
    location ~ /hls/.*\.(key|keyinfo)$ {
        deny all;
        return 404;
    }
    
    # Rate limiting for stream access
    limit_req_zone $binary_remote_addr zone=stream:10m rate=10r/m;
    location /hls/ {
        limit_req zone=stream burst=5 nodelay;
    }
}

# RTMP configuration for secure streaming
rtmp {
    server {
        listen 1935;
        chunk_size 4096;
        allow publish 127.0.0.1;  # Only allow local publishing
        deny publish all;
        
        application live {
            live on;
            
            # Only allow publishing from authorized sources
            allow publish 127.0.0.1;
            deny publish all;
            
            # HLS configuration
            hls on;
            hls_path /var/www/hls;
            hls_fragment 3;
            hls_playlist_length 60;
            hls_continuous on;
            hls_cleanup on;
            hls_nested on;
            
            # Security: Generate unique stream keys
            hls_variant _low BANDWIDTH=400000;
            hls_variant _mid BANDWIDTH=800000;
            hls_variant _high BANDWIDTH=1200000;
        }
    }
}